<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Boojet</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
 body{font-family:system-ui,sans-serif;margin:24px} table{width:100%;border-collapse:collapse;margin-top:12px}
 th,td{border-bottom:1px solid #ddd;padding:8px} .right{text-align:right} .muted{color:#666}
 form{display:grid;gap:8px;grid-template-columns:repeat(6,minmax(120px,1fr));align-items:end;margin-bottom:12px}
</style>
</head>
<body>
<h1>Boojet</h1>

<form id="f">
  <label>Description<br><input id="desc" required></label>
  <label>Amount<br><input id="amount" type="number" step="0.01" min="0" required></label>
  <label>Date<br><input id="date" type="date" required></label>
  <label>Category<br>
    <select id="cat">
      <option>FOOD</option><option>RENT</option><option>TRANSPORT</option>
      <option>ENTERTAINMENT</option><option>UTILITIES</option><option>HEALTH</option><option>OTHER</option>
    </select>
  </label>
  <label>Type<br>
    <select id="income"><option value="true">INCOME</option><option value="false">EXPENSE</option></select>
  </label>
  <span>
    <input type="hidden" id="editId">
    <button>Add</button>
    <button type="button" id="cancel" class="muted" style="display:none">Cancel</button>
  </span>
</form>

<div style="display:flex;gap:12px;align-items:center">
  <div class="muted">Balance:</div><div id="balance" style="font-weight:600">$0.00</div>
  <div style="margin-left:auto">
    <label>Filter: Cat <select id="fcat"><option value="">(All)</option>
      <option>FOOD</option><option>RENT</option><option>TRANSPORT</option>
      <option>ENTERTAINMENT</option><option>UTILITIES</option><option>HEALTH</option><option>OTHER</option>
    </select></label>
    <label>Year <input id="fyr" type="number" min="2000" max="2100" style="width:90px"></label>
    <label>Mon <input id="fmo" type="number" min="1" max="12" style="width:60px"></label>
    <button id="apply">Apply</button>
    <button id="reset" type="button">Reset</button>
  </div>
</div>

<table id="tbl">
  <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th class="right">Amount</th><th>Actions</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const API = '/transactions';
const $ = s => document.querySelector(s);

function money(n){ const v = (typeof n === 'number') ? n : (n?.amount ?? 0); return new Intl.NumberFormat(undefined,{style:'currency',currency:'CAD'}).format(v); }
function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function j(url, opts={}) {
  const r = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
  if(!r.ok) throw new Error(await r.text());
  return r.status===204?null:r.json();
}

async function loadAll(){
  const list = await j(API);
  render(list);
  try { $('#balance').textContent = money(await j(`${API}/balance`)); }
  catch { const sum = list.reduce((a,t)=>a+(t.income? t.amount : -t.amount),0); $('#balance').textContent = money(sum); }
}

function render(list){
  const tb = $('#tbl tbody'); tb.innerHTML='';
  list.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.date}</td>
      <td>${esc(t.description)}</td>
      <td>${t.category}</td>
      <td>${t.income?'INCOME':'EXPENSE'}</td>
      <td class="right">${money(t.amount)}</td>
      <td>
        <button onclick="edit(${t.id})">Edit</button>
        <button onclick="del(${t.id})">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
}

window.edit = async function(id){
  const t = await j(`${API}/${id}`);
  $('#editId').value = id;
  $('#desc').value = t.description;
  $('#amount').value = (typeof t.amount==='number'? t.amount : t.amount.amount);
  $('#date').value = t.date;
  $('#cat').value = t.category;
  $('#income').value = t.income ? 'true' : 'false';
  $('form button[type="submit"]').textContent='Update';
  $('#cancel').style.display='inline-block';
}
window.del = async function(id){
  if(!confirm('Delete this transaction?')) return;
  await fetch(`${API}/${id}`, {method:'DELETE'});
  await loadAll();
}

$('#f').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    description: $('#desc').value.trim(),
    amount: parseFloat($('#amount').value),
    date: $('#date').value,
    category: $('#cat').value,
    income: $('#income').value === 'true'
  };
  const id = $('#editId').value;
  if(id) await j(`${API}/${id}`, {method:'PUT', body: JSON.stringify(payload)});
  else   await j(API, {method:'POST', body: JSON.stringify(payload)});
  resetForm(); await loadAll();
});
$('#cancel').addEventListener('click', ()=>{ resetForm(); });

function resetForm(){
  $('#f').reset(); $('#editId').value=''; $('form button[type="submit"]').textContent='Add'; $('#cancel').style.display='none';
  $('#date').value = new Date().toISOString().slice(0,10);
}

$('#apply').addEventListener('click', async e=>{
  e.preventDefault();
  const cat = $('#fcat').value, yr = $('#fyr').value, mo = $('#fmo').value;
  let list = [];
  if (yr && mo) list = await j(`${API}/month/${yr}/${mo}`);
  else if (cat) list = await j(`${API}/category/${cat}`);
  else list = await j(API);
  render(list);
});
$('#reset').addEventListener('click', async ()=>{
  $('#fcat').value=''; $('#fyr').value=''; $('#fmo').value=''; await loadAll();
});

// defaults
resetForm(); loadAll();
</script>
</body>
</html>
